{% extends 'base.html' %}

{% block title %}Checkout{% endblock %}

{% block content %}
    <h1>Checkout</h1>

    <!-- Checkout Form -->
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Place Order</button>
    </form>

    <!-- Cart Summary -->
    <h2>Cart Summary</h2>
    <ul>
        {% for item in cart %}
        <li>{{ item.product.name }} - ${{ item.total_price }} ({{ item.quantity }})</li>
        {% endfor %}
    </ul>
    <p>Total: ${{ cart.get_total_price }}</p>

    <!-- Stripe Checkout Button -->
    <button id="checkout-button">Pay with Stripe</button>

    <!-- Stripe Integration -->
    <script src="https://js.stripe.com/v3/"></script>
    <script type="text/javascript">
        var stripe = Stripe('{{ stripe_publishable_key }}');
        document.getElementById('checkout-button').addEventListener('click', function () {
            fetch('/create-checkout-session/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            })
            .then(function (response) {
                return response.json();
            })
            .then(function (sessionId) {
                return stripe.redirectToCheckout({ sessionId: sessionId });
            });
        });
    </script>
{% endblock %}
